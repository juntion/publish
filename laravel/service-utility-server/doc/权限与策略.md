### 权限与策略

​	权限与策略都是管理用户调用接口的权限。其中权限是根据数据库查询用户权限在中间件部分进行验证，策略是在调用接口时根据具体情况进行判断。

#### 权限

​	`PM`项目与`UUMS` 项目权限的管理都是使用 [spatie/laravel-permission](https://github.com/spatie/laravel-permission) 包进行管理的。[查看文档](https://docs.spatie.be/laravel-permission/v3/)

#### 	新增接口

​	当要新增接口时，若该接口为公共接口不需要验证用户是否有权限时，其`Route` 的 `name` 最后必须是`.public` 结尾。	

```php
// 以public结尾为公共权限
Route::get('/departments/all', 'Department\DepartmentsController@all')->name('departments.all.public'); 
// 若结尾不是public 则表示该接口需要验证用户权限
Route::delete('/departments/{id}', 'Department\DepartmentsController@delete')->name('departments.delete'); 

```

​	 如果是需要验证权限的API则需要将路由信息添加至 `data/permission/projectManage/features.json` 文件中

```json
 "附件管理": [
        {
            "name": "medias.delete",
            "comment": "删除附件",
            "locale": {
                "en": "Delete media file",
                "zh-CN": "删除附件"
            }
        }
    ],
```

​	然后执行下面的命令行，将权限表更新
```shell
	$ php artisan db:seed --class=PermissionsTableSeeder
```
> 单独新增功能模块可参考 [前端路由管理>>单独增加新的功能模块](./前端路由管理.md)  

​	是否验证权限的逻辑可以参考 `app/Http/Controllers/Controller.php` 的构造方法

#### 策略

​	策略是在特定模型或者资源中组织授权逻辑的类。一般一个`Model` 对应一个`Policy `。使用策略时无需引入，策略支持自动发现。可以参考[laravel文档—策略相关](https://learnku.com/docs/laravel/5.8/authorization/3908#creating-policies )。

​	目前策略仅在`PM` 项目模块中使用.具体参考[操作策略说明](https://git.whgxwl.com:10025/King.Li/document/blob/master/%E6%96%B0%E7%89%88%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/%E6%93%8D%E4%BD%9C%E7%AD%96%E7%95%A5%E8%AF%B4%E6%98%8E.md )

####  	定义策略及使用

```php
// 策略的ClassName 必须是对应的Molde+Policy
class AppealPolicy
{
    /**
     * 编辑：发布人
     * @param User $user
     * @param Appeal $appeal
     * @return bool
     */
    public function edit(User $user, Appeal $appeal) 
    {
        return $user->id == $appeal->promulgator_id &&
            in_array($appeal->status, [
                AppealStatus::STATUS_TO_ACCEPT,
                AppealStatus::STATUS_FOLLOWING,
                AppealStatus::STATUS_SCHEDULING,
                AppealStatus::STATUS_TO_DISTRIBUTION,
            ]);
    }
}
// 策略的使用
if($this->user->can('edit', $appeal)){ // 判断是否有权限, 参数$appeal 必须是Model查询出的
    // 拥有策略权限的逻辑
}
```