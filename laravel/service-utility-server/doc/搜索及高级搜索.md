## 搜索及高级搜索

#### 使用的包

​	`PM` 项目及`UUMS` 项目均使用的是[spatie/laravel-query-builder](https://github.com/spatie/laravel-query-builder )来进行列表条件搜索。由前端传值进行条件约束。

#### 普通搜索

​	普通搜索分为两类，一类是可以直接搜索的无需添加条件，一类是需要添加` scope`方法。

​	但是无论是直接搜索还是 需添加`scope`的搜索，其所属的`Repository` 需继承自 `BaseRepository`，如下所示

​	

```php
class ProjectRepository extends BaseRepository 
{
    protected $allowedSearches = []; // 允许直接搜索的值
    protected $allowedScopeSearches = []; // 允许进行scope的键名
}
```

##### 		直接搜索

​	直接搜索是直接查询数据表的值或关联的数据表的值。例如需要筛选  `user`的`id` 为某一值的用户，只需要将`id` 添加至`$allowedSearches` 数组当中即可	
```php
  protected $allowedSearches = ['id']
```

##### 	scope 搜索

​	scope搜索是当列表的筛选条件不是一个数据表单独条件或不是 `=` 条件时使用。scope搜索需将搜索的字段添加至`$allowedScopeSearches`数组。同时需在对应的`Model`类完善对应的搜索逻辑

```php
class ProjectRepository extends BaseRepository 
{
    protected $allowedScopeSearches = ['keyWord']; // 允许进行scope的键名
}
// 假定keyword 是指name，content等多个字段中任意一个满足条件的筛选

class Project extends Model // 在对应的model里添加scope方法
{
    public function scopeKeyWord(Builder $builder, $data) // 需注意scope方法名需和字段名保持一致
    {
        $builder->where(function ($query)use ($data){
                $query->orWhere('name', 'like', $data)->orWhere('number', 'like', $data);
            });
        return $builder;
    }
}
```

#### 高级搜索

​	高级搜索同普通搜索大致一样，但是添加的数组不同。

​	前端的使用方式可以查看 [列表数据筛选说明](https://git.whgxwl.com:10025/King.Li/document/blob/master/%E6%96%B0%E7%89%88%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/%E5%88%97%E8%A1%A8%E6%95%B0%E6%8D%AE%E7%AD%9B%E9%80%89%E8%AF%B4%E6%98%8E.md)

​	高级搜索不同于普通搜索的是，高级搜索前端除了需要传递搜索的字段和搜索的值外，还需要额外传搜索的类型。例如是 `like` `in list` `is` `notis` `between` 等等，具体支持的类型可以参考 `app\Enums\ProjectManage\QueryType.php` 文件下的支持类型。

​	具体的实现逻辑查看 `app/Traits/QueryBuilder/MustQuery.php` 及 `app/Traits/QueryBuilder/MayQuery.php`

##### 	直接搜索

​	直接搜索是直接查询数据表的值或关联的数据表的值。例如需要筛选  `user`的`id` 满足某一条件的用户，只需要将`id` 添加至`$allowedMust`数组当中即可	

```php
protected $allowedMust = ['id'] 
```

#####  	scope 搜索

​	和普通搜索使用情况一样也是在组合条件下使用，筛选多个条件同时满足的数据。scope搜索需将搜索的字段添加至`$allowedScopeMust`数组。同时需在对应的`Model`类完善对应的搜索逻辑

​	

```php
class ProjectRepository extends BaseRepository 
{
    protected $allowedScopeMust = ['productLine']; // 允许进行scope的键名 
}

class Project extends Model // 在对应的model里添加scope方法
{
    public function scopeProductLine(Builder $builder, ...$data)
    {
        $type = $data[0]; // $type 是筛选的条件类型，如 like, between 
        $val = $data[1]; // $val 是筛选的值
        $searchType = $data[2]; //$searchType 是筛选的类型，及前端展示的 or/and 条件
        return $this->searchProduct($builder, $val, $type, ProductStatus::TypeLine, $searchType);
    }
    
    // 因为前端有两种情况（or/and） 因此每一个scope 都应该有对应情况的方法
    // 这里可以参考 app/Traits/SearchProduct.php 文件的逻辑
    protected function searchProduct(Builder $builder, $val, $type, $product_type, $searchType)
    {
        if ($searchType == 'may'){
            $builder = $builder->orWhereHas('products', function($query)use($type, $val, $product_type){
                $query->where('type', $product_type)->where(function ($q)use($type, $val){
                    (new MayFilter())->getSqlByTypeAndVal($q, $type, $val, 'name');
                });
            });
        } else {
            $builder = $builder->WhereHas('products', function($query)use($type, $val, $product_type){
                $query->where('type', $product_type)->where(function ($q)use($type, $val){
                    (new MustFilter())->getSqlByTypeAndVal($q, $type, $val, 'name');
                });
            });
        }
        return $builder;
    }
}
```

